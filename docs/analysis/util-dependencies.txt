# Utility Layer Dependencies
# Generated: 2026-01-17
# Task 4: Trace Service and Utility Layer Dependencies

## Summary
- Total utility files: 17 utils + 1 hooks + 1 lib = 19 total
- Reachable utilities: 17 (89.5%)
- Dead code candidates: 2 files (use-mobile.tsx, dataSync.ts, lib/utils.ts)
- All utilities follow clear dependency patterns

---

## Core Utilities (17 files)

### 1. utils/errors.ts
**Purpose**: Centralized error handling and user-facing error messages
**Dependencies**: None (core utility)

**Imported By** (45+ locations):
- main.tsx
- All services (TranslationService, TranslationOrchestrator, transcriptionPipeline, SubtitleFileManager, dataManager, all DataManager modules)
- All stores (subtitleStore, translationConfigStore, transcriptionStore)
- All contexts (TermsContext, HistoryContext)
- All components (ErrorBoundary, SubtitleEditor, etc.)
- Many utilities (fileExport, srtParser, dataSync)

**Exports**: toAppError, getUserMessage, AppError class
**Reachable**: YES (critical infrastructure - highest usage)
**Usage**: Universal error handling pattern

---

### 2. hooks/useErrorHandler.ts
**Purpose**: React hook for error handling with toast notifications
**Dependencies**: utils/errors

**Imported By**:
- All components (FileUpload, BatchFileUpload, SubtitleFileList, TranslationControls, SubtitleEditor, TermsManager, HistoryModal, TranscriptionSettings)
- All contexts (TermsContext, HistoryContext, SubtitleContext)

**Exports**: useErrorHandler hook
**Reachable**: YES (used by 15+ components)
**Usage**: Standardized error handling in UI layer

---

### 3. utils/llmApi.ts
**Purpose**: LLM API integration with retry logic and rate limiting
**Dependencies**:
- Utils: rateLimiter
- Constants: api (API_CONSTANTS)
- Types: types

**Imported By**:
- services/TranslationService.ts
- services/transcriptionPipeline.ts

**Exports**: callLLM
**Reachable**: YES (core translation/transcription infrastructure)
**Usage**: All LLM API calls go through this utility

---

### 4. utils/rateLimiter.ts
**Purpose**: Token bucket rate limiting for API calls
**Dependencies**: None (standalone utility)

**Imported By**:
- utils/llmApi.ts

**Exports**: TokenBucket class
**Reachable**: YES (used by llmApi)
**Usage**: Prevents API rate limit violations

---

### 5. utils/translationPrompts.ts
**Purpose**: LLM prompt templates for translation and sentence segmentation
**Dependencies**: None (prompt templates)

**Imported By**:
- services/TranslationService.ts
- services/transcriptionPipeline.ts

**Exports**: generateSharedPrompt, generateDirectPrompt, generateReflectionPrompt, getSentenceSegmentationPrompt
**Reachable**: YES (used by translation/transcription services)
**Usage**: Centralized prompt management

---

### 6. utils/srtParser.ts
**Purpose**: SRT file parsing and format conversion
**Dependencies**:
- Utils: errors (toAppError)
- Types: types

**Imported By**:
- services/SubtitleFileManager.ts
- services/SubtitleExporter.ts

**Exports**: parseSRT, toSRT, toTXT, toBilingual
**Reachable**: YES (core file I/O infrastructure)
**Usage**: SRT file handling

---

### 7. utils/fileFormat.ts
**Purpose**: File type detection and size formatting
**Dependencies**:
- Types: types

**Imported By**:
- services/SubtitleFileManager.ts (detectFileType)
- components/SubtitleFileList/utils/fileHelpers.ts (formatFileSize)
- utils/timeFormat.ts

**Exports**: detectFileType, formatFileSize
**Reachable**: YES (used by file operations)
**Usage**: File metadata handling

---

### 8. utils/fileExport.ts
**Purpose**: File download utilities for browser
**Dependencies**:
- Utils: errors (toAppError)

**Imported By**:
- components/HistoryModal.tsx (downloadSubtitleFile)
- components/TermsManager.tsx (downloadTextFile)
- components/TranslationControls.tsx (downloadSubtitleFile)
- components/SubtitleFileList/index.tsx (downloadSubtitleFile)

**Exports**: downloadSubtitleFile, downloadTextFile
**Reachable**: YES (used by export UI components)
**Usage**: Browser file downloads

---

### 9. utils/fileUtils.ts
**Purpose**: File operation utilities for transcription workflow
**Dependencies**:
- Types: types/transcription

**Imported By**:
- components/SubtitleFileList/components/FileActionButtons.tsx

**Exports**: canRetranscribe
**Reachable**: YES (used by file action buttons)
**Usage**: Workflow validation

---

### 10. utils/taskIdGenerator.ts
**Purpose**: Generate stable IDs for tasks and files
**Dependencies**: None (standalone utility)

**Imported By**:
- services/SubtitleFileManager.ts (generateTaskId, generateStableFileId)
- stores/subtitleStore.ts (generateStableFileId)
- components/TranslationControls.tsx (generateTaskId)

**Exports**: generateTaskId, generateStableFileId
**Reachable**: YES (used by task/file management)
**Usage**: ID generation for persistence

---

### 11. utils/silenceDetection.ts
**Purpose**: Audio silence detection for chunking
**Dependencies**:
- Constants: transcription (AUDIO_CONSTANTS)

**Imported By**:
- services/transcriptionPipeline.ts

**Exports**: findSilencePoints, createChunkPlan
**Reachable**: YES (used by transcription pipeline)
**Usage**: Audio preprocessing

---

### 12. utils/batchProcessor.ts
**Purpose**: Batch creation for transcription with word limits
**Dependencies**:
- Utils: transcriptionHelpers
- Constants: transcription (TRANSCRIPTION_BATCH_CONSTANTS)

**Imported By**:
- services/transcriptionPipeline.ts

**Exports**: createBatches, logBatchOverview
**Reachable**: YES (used by transcription pipeline)
**Usage**: Transcription batch management

---

### 13. utils/sentenceTools.ts
**Purpose**: Sentence segmentation tools for LLM output
**Dependencies**: None (standalone utility)

**Imported By**:
- services/transcriptionPipeline.ts

**Exports**: getLlmWordsAndSplits, mapLlmSplitsToOriginal, reconstructSentences
**Reachable**: YES (used by transcription pipeline)
**Usage**: LLM sentence segmentation

---

### 14. utils/timeFormat.ts
**Purpose**: Time formatting for SRT timestamps
**Dependencies**:
- Types: types
- Utils: fileFormat (formatFileSize)

**Imported By**:
- services/transcriptionPipeline.ts

**Exports**: formatSRTTime
**Reachable**: YES (used by transcription pipeline)
**Usage**: Timestamp formatting

---

### 15. utils/transcriptionHelpers.ts
**Purpose**: Transcription-specific helper functions
**Dependencies**:
- Constants: transcription (TRANSCRIPTION_PROGRESS)
- Types: types

**Imported By**:
- utils/batchProcessor.ts

**Exports**: calculateProgress, getProgressMessage
**Reachable**: YES (used by batch processor)
**Usage**: Progress calculation

---

### 16. utils/loadModelFromCache.ts
**Purpose**: Load Whisper model from browser cache
**Dependencies**:
- Types: types

**Imported By**:
- stores/transcriptionStore.ts

**Exports**: loadModelFromCache
**Reachable**: YES (used by transcription store)
**Usage**: Whisper model loading

---

### 17. utils/dataSync.ts
**Purpose**: Storage synchronization utilities (wrapper around localforage)
**Dependencies**:
- Utils: errors (toAppError)
- External: localforage

**Imported By**:
- None (no imports found)

**Exports**: syncStorage, clearStorage
**Reachable**: NO (dead code candidate)
**Usage**: Legacy code - superseded by dataManager modules

---

## Hooks (1 file)

### hooks/useErrorHandler.ts
**Documented above as #2**

---

## Dead Code Candidates (2 files)

### 1. hooks/use-mobile.tsx
**Purpose**: Mobile detection hook using matchMedia
**Dependencies**: None (standalone hook)

**Imported By**:
- None (no imports found)

**Exports**: useIsMobile
**Reachable**: NO (dead code)
**Analysis**: This hook exports `useIsMobile` but it's never imported anywhere in the codebase. The application appears to use responsive CSS instead of JavaScript-based mobile detection.

**Recommendation**: Safe to remove

---

### 2. lib/utils.ts
**Purpose**: General utility for CSS class merging (cn function)
**Dependencies**:
- External: clsx, tailwind-merge

**Imported By**:
- None (the `cn` function is never called)

**Exports**: cn (className utility)
**Reachable**: NO (dead code)
**Analysis**: This file exports a `cn` function for merging Tailwind CSS classes, but it's never imported or used anywhere. The application may have been scaffolded with shadcn/ui but doesn't use this utility.

**Recommendation**: Safe to remove

---

## Utility Dependency Graph

```
┌─────────────────────────────────────────────────────────────┐
│                      Services & Stores                       │
│                 (subtitleStore, Services)                    │
└────────────────────────┬────────────────────────────────────┘
                         │
         ┌───────────────┼───────────────┐
         │               │               │
         ▼               ▼               ▼
┌──────────────┐ ┌─────────────┐ ┌──────────────┐
│  Core Utils  │ │  LLM Utils  │ │  File Utils  │
│              │ │             │ │              │
│ • errors     │ │ • llmApi    │ │ • srtParser  │
│ • rateLimit  │ │ • prompts   │ │ • fileFormat │
│ • taskIds    │ │             │ │ • fileExport │
└──────────────┘ └──────┬──────┘ └──────────────┘
                        │
         ┌──────────────┼──────────────┐
         │              │              │
         ▼              ▼              ▼
┌──────────────┐ ┌─────────────┐ ┌──────────────┐
│ Transcription│ │  Audio Utils│ │  Data Utils  │
│              │ │             │ │              │
│ • batchProc  │ │ • silence   │ │ • dataSync   │
│ • sentence   │ │ • timeFormat│ │ ❌ DEAD CODE │
│ • transHelp  │ │             │ │              │
│ • modelCache │ │             │ │              │
└──────────────┘ └─────────────┘ └──────────────┘

┌─────────────────────────────────────────────────────────────┐
│                         DEAD CODE                            │
│  • hooks/use-mobile.tsx (never imported)                    │
│  • lib/utils.ts (cn function never called)                  │
│  • utils/dataSync.ts (superseded by dataManager)            │
└─────────────────────────────────────────────────────────────┘
```

## Utility Usage Patterns

### High Usage (Critical Infrastructure)
1. **errors.ts**: 45+ import locations - universal error handling
2. **useErrorHandler**: 15+ components - standardized UI error handling
3. **llmApi**: Core LLM integration
4. **srtParser**: Core file I/O
5. **taskIdGenerator**: Task/file ID management

### Medium Usage (Feature-Specific)
6. **translationPrompts**: Translation/transcription
7. **fileFormat**: File operations
8. **fileExport**: Export functionality
9. **silenceDetection**: Transcription preprocessing
10. **batchProcessor**: Transcription batching
11. **sentenceTools**: Sentence segmentation
12. **timeFormat**: Timestamp formatting
13. **transcriptionHelpers**: Progress tracking
14. **loadModelFromCache**: Whisper model loading
15. **fileUtils**: Workflow validation
16. **rateLimiter**: API rate limiting

### Low Usage (Dead Code Candidates)
17. **dataSync**: No imports - legacy code
18. **use-mobile**: No imports - unused mobile detection
19. **lib/utils**: No imports - unused CSS utility

## Key Findings

### Reachable Utilities: 17/19 (89.5%)
- 17 utility files are actively used
- Clear dependency patterns
- No circular dependencies

### Dead Code Candidates: 2/19 (10.5%)
1. **hooks/use-mobile.tsx**: Never imported, mobile detection not needed
2. **lib/utils.ts**: Never imported, cn function never called
3. **utils/dataSync.ts**: Never imported, superseded by dataManager modules

### Architecture Quality
- Utilities are well-organized by purpose
- Clear separation between core, LLM, file, and transcription utilities
- Dependencies flow in one direction (services → utils)
- No utility depends on services (correct architecture)

### Recommendation
- Remove 3 dead code files (use-mobile.tsx, lib/utils.ts, dataSync.ts)
- This will reduce utility count from 19 to 16 files
- No impact on functionality (unused code)
